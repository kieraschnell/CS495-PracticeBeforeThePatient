@page "/demo"
@rendermode InteractiveServer
@attribute [StreamRendering]
@using PracticeBeforeThePatient.Web.Services
@inject ApiClient Api
@inject IJSRuntime JS

<PageTitle>Demo</PageTitle>

<div class="simShell">
    <div class="card">
        <div class="sectionTitle">Demo</div>
        <div class="narrLine">A demo video will go here.</div>

        <div class="divider"></div>

        <div class="sectionTitle">Mock Login (Temporary)</div>
        <div class="narrLine">Current user: @CurrentUserLabel</div>
        <div class="narrLine">Role: @(IsAdmin ? "Admin" : "Student")</div>

        @if (!string.IsNullOrWhiteSpace(StatusMessage))
        {
            <div class="saveMessage @StatusKind">@StatusMessage</div>
        }

        <div class="createRow">
            <input class="editorInput"
                   value="@EmailInput"
                   @oninput="OnEmailInput"
                   @onkeydown="OnEmailInputKeyDown"
                   placeholder="student@ua.edu (blank clears user)" />
            <button class="primaryBtn" @onclick="ApplyUserAsync" disabled="@IsSaving">Apply</button>
        </div>
    </div>
</div>

@code {
    private string EmailInput { get; set; } = "";
    private string CurrentUserLabel { get; set; } = "(none)";
    private bool IsAdmin { get; set; }
    private bool IsSaving { get; set; }
    private string StatusMessage { get; set; } = "";
    private string StatusKind { get; set; } = "success";
    private string? _themeToApply;

    protected override async Task OnInitializedAsync()
    {
        await RefreshAccessAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        if (!string.IsNullOrWhiteSpace(_themeToApply))
        {
            await JS.InvokeVoidAsync("pbpTheme.setTheme", _themeToApply);
        }
    }

    private void OnEmailInput(ChangeEventArgs e)
    {
        EmailInput = e.Value?.ToString() ?? "";
    }

    private async Task ApplyUserAsync()
    {
        IsSaving = true;
        StatusMessage = "";

        try
        {
            var access = await Api.SetCurrentDevUserAsync(EmailInput);

            if (access is null)
            {
                SetStatus("Could not update mock user.", false);
                return;
            }

            CurrentUserLabel = string.IsNullOrWhiteSpace(access.Email) ? "(none)" : access.Email;
            IsAdmin = access.IsAdmin;
            EmailInput = access.Email ?? "";
            _themeToApply = NormalizeTheme(access.Theme);
            if (!string.IsNullOrWhiteSpace(_themeToApply))
            {
                await JS.InvokeVoidAsync("pbpTheme.setTheme", _themeToApply);
            }
            SetStatus("Mock user updated.", true);
        }
        finally
        {
            IsSaving = false;
        }
    }

    private async Task OnEmailInputKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !IsSaving)
        {
            await ApplyUserAsync();
        }
    }

    private async Task RefreshAccessAsync()
    {
        var access = await Api.GetAccessAsync();
        CurrentUserLabel = string.IsNullOrWhiteSpace(access?.Email) ? "(none)" : access!.Email;
        IsAdmin = access?.IsAdmin == true;
        EmailInput = access?.Email ?? "";
        _themeToApply = NormalizeTheme(access?.Theme);
    }

    private void SetStatus(string message, bool ok)
    {
        StatusMessage = message;
        StatusKind = ok ? "success" : "error";
    }

    private static string? NormalizeTheme(string? theme)
    {
        if (string.Equals(theme, "dark", StringComparison.OrdinalIgnoreCase))
        {
            return "dark";
        }

        if (string.Equals(theme, "light", StringComparison.OrdinalIgnoreCase))
        {
            return "light";
        }

        return null;
    }
}
