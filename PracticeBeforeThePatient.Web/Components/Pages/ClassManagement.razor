@page "/class-management"
@rendermode InteractiveServer
@using PracticeBeforeThePatient.Web.Services
@inject ApiClient Api

<PageTitle>Class Management</PageTitle>

@if (!_isAdminLoaded)
{
    <div class="card">
        <div class="sectionTitle">Loading</div>
        <div class="narrLine">Checking access</div>
    </div>
    return;
}

@if (!_isAdmin)
{
    <div class="card">
        <div class="sectionTitle">Not available</div>
        <div class="narrLine">This page is only available to admins</div>
    </div>
    return;
}

<div class="simShell">
    <div class="simHeaderRow">
        <div class="simHeaderText">
            <div class="simBadge">Instructor</div>
            <div class="simTitle">Class Management</div>
            <div class="simSubtitle">Create classes, add students, remove students</div>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(_message))
    {
        <div class="saveMessage @_messageKind classMessage">@_message</div>
    }

    <div class="card" @onclick="CloseMenu">
        <div class="sectionTitle">Choose an action</div>

        <div class="actionChips">
            <button class="@ChipClass(ActionMode.Create)" @onclick="() => SetModeAsync(ActionMode.Create)">Create new class</button>
            <button class="@ChipClass(ActionMode.Edit)" @onclick="() => SetModeAsync(ActionMode.Edit)">Edit class</button>
        </div>

        @if (_mode == ActionMode.Create)
        {
            <div class="createArea">
                <label class="editorLabel">Class name</label>
                <div class="createRow">
                    <input class="editorInput" value="@_newClassName" @oninput="OnNewClassNameInput" placeholder="Example, AT 301 Lab Section A" />
                    <button class="primaryBtn" @onclick="CreateClassAsync" disabled="@string.IsNullOrWhiteSpace(_newClassName)">Create</button>
                </div>
                <div class="createHint">Class names must be unique</div>
            </div>
        }

        @if (_mode == ActionMode.Edit)
        {
            <div class="editArea">
                <div class="editTopRow">
                    <div class="editSelect">
                        <label class="editorLabel">Select a class</label>
                        <select class="editorInput" value="@_selectedClassId" @onchange="OnSelectedClassChanged">
                            <option value="">Select</option>
                            @foreach (var c in _classes)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </select>
                    </div>

                    <div class="kebabWrap" @onclick:stopPropagation="true">
                        <button class="kebabBtn" @onclick="ToggleMenu" disabled="@string.IsNullOrWhiteSpace(_selectedClassId)">&#8942;</button>

                        @if (_menuOpen && !string.IsNullOrWhiteSpace(_selectedClassId))
                        {
                            <div class="kebabMenu">
                                <button class="kebabMenuItem danger" @onclick="DeleteSelectedClassAsync">Delete class</button>
                            </div>
                        }
                    </div>
                </div>

                @if (_selectedClass is not null)
                {
                    <div class="divider"></div>

                    <div class="sectionTitle">Scenario Access</div>

                    @if (_isLoadingScenarios)
                    {
                        <div class="infoMessage">Loading scenarios</div>
                    }
                    else if (_allScenarioIds.Count == 0)
                    {
                        <div class="warningMessage">No scenarios found in the API</div>
                    }
                    else
                    {
                        <div class="scenarioAccessTop">
                            <div class="scenarioAccessHint">
                                Select which scenarios this class can use. If none are selected, all scenarios are allowed.
                            </div>
                            <button class="secondaryBtn" @onclick="SaveScenarioAccessAsync" disabled="@(_selectedClass is null)">Save access</button>
                        </div>

                        <div class="scenarioAccessGrid">
                            @foreach (var id in _allScenarioIds)
                            {
                                var on = _allowedScenarioIds.Contains(id, StringComparer.OrdinalIgnoreCase);
                                <label class="scenarioAccessItem">
                                    <input type="checkbox" checked="@on" @onchange="(e) => ToggleScenario(id, e)" />
                                    <span class="scenarioAccessText">@id</span>
                                </label>
                            }
                        </div>
                    }

                    <div class="divider"></div>

                    <div class="sectionTitle">Manage Students</div>

                    <div class="classMgmtAddRow">
                        <div class="classMgmtAddInput">
                            <label class="editorLabel">Student email</label>
                            <input class="editorInput" value="@_emailToAdd" @oninput="OnEmailInput" placeholder="student@ua.edu" />
                        </div>

                        <div class="classMgmtAddBtn">
                            <label class="editorLabel">&nbsp;</label>
                            <button class="primaryBtn" @onclick="AddStudentAsync" disabled="@string.IsNullOrWhiteSpace(_emailToAdd)">Add student</button>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="classMgmtRosterHeader">
                        <div class="panel-title">Roster</div>
                        <div class="classMgmtCount">@_selectedClass.Students.Count student(s)</div>
                    </div>

                    @if (_selectedClass.Students.Count == 0)
                    {
                        <div class="infoMessage">No students yet, add one using the email field above</div>
                    }
                    else
                    {
                        <div class="classMgmtRoster">
                            @foreach (var email in _selectedClass.Students.OrderBy(x => x))
                            {
                                <div class="classMgmtStudent">
                                    <div class="classMgmtStudentEmail">@email</div>
                                    <button class="deleteBtn" @onclick="() => RemoveStudentAsync(email)">Remove</button>
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        }
    </div>
</div>

@code {
    private enum ActionMode
    {
        Create,
        Edit
    }

    private ActionMode _mode = ActionMode.Create;

    private List<ClassRosterDto> _classes = new();
    private string _newClassName = "";
    private string _selectedClassId = "";
    private ClassRosterDto? _selectedClass;
    private string _emailToAdd = "";

    private string _message = "";
    private string _messageKind = "success";

    private bool _menuOpen;

    private bool _isLoadingScenarios;
    private List<string> _allScenarioIds = new();
    private HashSet<string> _allowedScenarioIds = new(StringComparer.OrdinalIgnoreCase);

    private bool _isAdminLoaded;
    private bool _isAdmin;

    protected override async Task OnInitializedAsync()
    {
        var access = await Api.GetAccessAsync();
        _isAdmin = access?.IsAdmin == true;
        _isAdminLoaded = true;

        if (_isAdmin)
        {
            await ReloadClassesAsync();
        }
    }


    private async Task SetModeAsync(ActionMode mode)
    {
        _mode = mode;
        _menuOpen = false;

        if (_mode == ActionMode.Create)
        {
            _selectedClassId = "";
            _selectedClass = null;
            _emailToAdd = "";
            _allScenarioIds = new List<string>();
            _allowedScenarioIds = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            return;
        }

        await ReloadClassesAsync();
    }

    private string ChipClass(ActionMode mode)
    {
        return mode == _mode ? "actionChip selected" : "actionChip";
    }

    private void ToggleMenu()
    {
        _menuOpen = !_menuOpen;
    }

    private void CloseMenu()
    {
        _menuOpen = false;
    }

    private void SetMessage(string text, bool ok)
    {
        _message = text;
        _messageKind = ok ? "success" : "error";
        StateHasChanged();
        _ = ClearMessageLater();
    }

    private async Task ClearMessageLater()
    {
        await Task.Delay(3000);
        _message = "";
        await InvokeAsync(StateHasChanged);
    }

    private void OnNewClassNameInput(ChangeEventArgs e)
    {
        _newClassName = (e.Value?.ToString() ?? "").Trim();
    }

    private void OnEmailInput(ChangeEventArgs e)
    {
        _emailToAdd = (e.Value?.ToString() ?? "").Trim();
    }

    private async Task ReloadClassesAsync()
    {
        try
        {
            var data = await Api.Http.GetFromJsonAsync<List<ClassRosterDto>>("api/classes");
            _classes = data ?? new List<ClassRosterDto>();
            _selectedClass = _classes.FirstOrDefault(x => x.Id == _selectedClassId);
        }
        catch
        {
            _classes = new List<ClassRosterDto>();
            _selectedClass = null;
            SetMessage("Could not load classes from the API", false);
        }
    }

    private async Task ReloadScenarioAccessAsync()
    {
        if (_selectedClass is null)
        {
            _allScenarioIds = new List<string>();
            _allowedScenarioIds = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            return;
        }

        _isLoadingScenarios = true;

        try
        {
            var all = await Api.Http.GetFromJsonAsync<List<string>>("api/scenarios");
            _allScenarioIds = (all ?? new List<string>())
                .OrderBy(x => x, StringComparer.OrdinalIgnoreCase)
                .ToList();

            var allowed = await Api.Http.GetFromJsonAsync<List<string>>($"api/classes/{_selectedClass.Id}/scenarios");
            _allowedScenarioIds = new HashSet<string>(allowed ?? new List<string>(), StringComparer.OrdinalIgnoreCase);
        }
        catch
        {
            _allScenarioIds = new List<string>();
            _allowedScenarioIds = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            SetMessage("Could not load scenario access from the API", false);
        }
        finally
        {
            _isLoadingScenarios = false;
        }
    }

    private void ToggleScenario(string id, ChangeEventArgs e)
    {
        var on = e.Value is bool b && b;

        if (on)
        {
            _allowedScenarioIds.Add(id);
        }
        else
        {
            _allowedScenarioIds.Remove(id);
        }
    }

    private async Task SaveScenarioAccessAsync()
    {
        if (_selectedClass is null) return;

        try
        {
            var payload = new SetScenarioAccessRequest
            {
                ScenarioIds = _allowedScenarioIds.OrderBy(x => x, StringComparer.OrdinalIgnoreCase).ToList()
            };

            var resp = await Api.Http.PutAsJsonAsync($"api/classes/{_selectedClass.Id}/scenarios", payload);

            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                SetMessage($"Save failed {((int)resp.StatusCode)} {body}", false);
                return;
            }

            SetMessage("Scenario access saved", true);
        }
        catch
        {
            SetMessage("Could not save scenario access", false);
        }
    }

    private async Task CreateClassAsync()
    {
        var name = _newClassName.Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            SetMessage("Enter a class name", false);
            return;
        }

        try
        {
            var resp = await Api.Http.PostAsJsonAsync("api/classes", new CreateClassRequest { Name = name });

            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                SetMessage($"Create failed {((int)resp.StatusCode)} {body}", false);
                return;
            }

            var created = await resp.Content.ReadFromJsonAsync<ClassRosterDto>();
            _newClassName = "";
            _selectedClassId = created?.Id ?? "";
            SetMessage("Class created", true);

            await ReloadClassesAsync();
        }
        catch
        {
            SetMessage("Could not create class", false);
        }
    }

    private async Task DeleteSelectedClassAsync()
    {
        _menuOpen = false;

        if (string.IsNullOrWhiteSpace(_selectedClassId))
        {
            SetMessage("Select a class first", false);
            return;
        }

        try
        {
            var resp = await Api.Http.DeleteAsync($"api/classes/{_selectedClassId}");
            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                SetMessage($"Delete failed {((int)resp.StatusCode)} {body}", false);
                return;
            }

            _selectedClassId = "";
            _selectedClass = null;
            _emailToAdd = "";
            _allScenarioIds = new List<string>();
            _allowedScenarioIds = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            SetMessage("Class deleted", true);

            await ReloadClassesAsync();
        }
        catch
        {
            SetMessage("Could not delete class", false);
        }
    }

    private async Task OnSelectedClassChanged(ChangeEventArgs e)
    {
        _selectedClassId = e.Value?.ToString() ?? "";
        _emailToAdd = "";
        _menuOpen = false;

        await ReloadClassesAsync();
        await ReloadScenarioAccessAsync();
    }

    private async Task AddStudentAsync()
    {
        if (_selectedClass is null)
        {
            SetMessage("Select a class first", false);
            return;
        }

        var email = _emailToAdd.Trim().ToLowerInvariant();
        if (!LooksLikeEmail(email))
        {
            SetMessage("Enter a valid email", false);
            return;
        }

        try
        {
            var resp = await Api.Http.PostAsJsonAsync($"api/classes/{_selectedClass.Id}/students", new StudentRequest { Email = email });
            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                SetMessage($"Add failed {((int)resp.StatusCode)} {body}", false);
                return;
            }

            _emailToAdd = "";
            SetMessage("Student added", true);
            await ReloadClassesAsync();
        }
        catch
        {
            SetMessage("Could not add student", false);
        }
    }

    private async Task RemoveStudentAsync(string email)
    {
        if (_selectedClass is null) return;

        try
        {
            var req = new HttpRequestMessage(HttpMethod.Delete, $"api/classes/{_selectedClass.Id}/students")
            {
                Content = JsonContent.Create(new StudentRequest { Email = email })
            };

            var resp = await Api.Http.SendAsync(req);
            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                SetMessage($"Remove failed {((int)resp.StatusCode)} {body}", false);
                return;
            }

            SetMessage("Student removed", true);
            await ReloadClassesAsync();
        }
        catch
        {
            SetMessage("Could not remove student", false);
        }
    }

    private static bool LooksLikeEmail(string value)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(value);
            return string.Equals(addr.Address, value, StringComparison.OrdinalIgnoreCase);
        }
        catch
        {
            return false;
        }
    }

    private sealed class ClassRosterDto
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public List<string> Students { get; set; } = new();
    }

    private sealed class CreateClassRequest
    {
        public string Name { get; set; } = "";
    }

    private sealed class StudentRequest
    {
        public string Email { get; set; } = "";
    }

    private sealed class SetScenarioAccessRequest
    {
        public List<string> ScenarioIds { get; set; } = new();
    }
}
